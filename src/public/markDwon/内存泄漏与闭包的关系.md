# 内存泄漏与闭包的关系



前段时间朋友问我，如何解决内存泄漏的，直接把我问住了。

我心想没听说能解决啊，这个应该不写那样的代码就行了，我查了关于这个问题的一些资料，发现解决的确等于避免出现这个场面，但是也看到两篇文章，让我发现我的理解是有偏差的。给我补上这一课。

先说何为内存泄漏，程序的运行需要内存。只要程序提出要求，操作系统或者运行时（runtime）就必须供给内存。对于持续运行的服务进程（daemon），必须及时释放不再用到的内存。否则，内存占用越来越高，轻则影响系统性能，重则导致进程崩溃。不再用到的内存，没有及时释放，就叫做[内存泄漏](https://www.xttblog.com/?tag=内存泄漏)（memory leak）。

举个知乎上的例子，这里有十块黑板，给十个人用，用完擦干净，就可以给下一个人用。现在有个坏蛋，不但不擦干净，还抱着黑板跑了，现在还剩九块黑板。如果坏人多了，就没有黑板可以用了。

```javascript
function isEven (num) {
    if (num === 0) {
        return true;
    }
    if (num === 1) {
        return false;
    }
    return isEven(Math.abs(num) - 2);
}
//Outputs: true
console.log(isEven(10));
//Outputs: false
console.log(isEven(9));
```

这个例子看起来没有什么特别的，但是把参数换成较大的数，例如10000。

浏览器会报这个错误   Uncaught RangeError: Maximum call stack size exceeded

作者提出了，使用闭包的方式，改进一下这个函数即可解决。

```javascript
function isEven (num) {
    if (num === 0) {
        return true;
    }
    if (num === 1) {
        return false;
    }
    return function() {
        return isEven(Math.abs(num) - 2);
    }
}
function trampoline (func, arg) {
    var value = func(arg);
    while(typeof value === "function") {
        value = value();
    }
    return value;
}
//Outputs: true
console.log(trampoline(isEven, 10000));
//Outputs: false
console.log(trampoline(isEven, 10001));
```

的确解决了问题，但是以前总是听说，闭包的副作用就是变量无法释放，大量使用会造成内存泄漏。我第一次听说闭包竟然可以解决内存泄漏的问题。

先代浏览器环境，闭包一般都能回收，但也存在无法回收的情况，无法回收主要是代码问题。

先说结论，其实闭包函数是否可以回收与它的外层函数是无关的，只与是否有引用指向它有关。从这一点上看，闭包函数与普通对象是一样一样儿的。（不限定回收策略，引用计数也行，可达性判定也行）。

同样用例子来说明

```javascript
const fn = function() {
    let num = 0;
    
    return function() {
        return num += 1;
    }
}

fn()() // 1
fn()() // 1
fn()() // 1
```

上面这段代码就是最简单的闭包，如果我们此时在浏览器控制台执行这段代码，那么不管执行多少次，控制台得到的结果都是1，实际上 fn 就被回收掉了。

但如果我们这么写

```javascript
const fn = function() {
    let num = 0;
    
    return function() {
        return num += 1;
    }
}

let f1 = fn();

f1(); // 1
f1(); // 2
f1(); // 3

```

此时的 f1 就是闭包的引用，因此就没法被回收掉。（释放掉引用就会被GC算法回收。）



参考网址：[https://segmentfault.com/q/1010000020309203]()，[](https://www.xttblog.com/?p=2045)

